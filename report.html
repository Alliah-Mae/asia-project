<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto-Generated Report - Local Youth Development Office</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(120deg, #e3f2fd 0%, #f8fafc 100%);
      margin: 0;
    }
    .main-content {
      min-height: 90vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding-top: 40px;
      padding-bottom: 40px;
    }
    .report-card {
      background: #fff;
      border-radius: 1.5rem;
      box-shadow: 0 8px 32px rgba(67, 97, 238, 0.10), 0 2px 8px rgba(0,0,0,0.04);
      padding: 2.5rem 2.5rem 2rem 2.5rem;
      max-width: 900px;
      width: 100%;
      text-align: left;
      position: relative;
    }
    .report-header {
      display: flex;
      align-items: center;
      gap: 1.2rem;
      margin-bottom: 1.5rem;
    }
    .report-logo {
      background: rgba(67, 97, 238, 0.08);
      border-radius: 50%;
      width: 70px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .report-title {
      font-size: 2.1rem;
      font-weight: 800;
      color: #3f51b5;
      margin-bottom: 0.2rem;
    }
    .report-form {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: end;
      margin-bottom: 2rem;
    }
    .report-form label {
      font-weight: 500;
      color: #3f51b5;
    }
    .report-form input, .report-form select {
      border-radius: 50px;
      border: 1px solid #bdbdbd;
      padding: 0.4rem 1rem;
      font-size: 1rem;
    }
    .report-form select[multiple] {
      min-width: 160px;
      height: 2.5rem;
    }
    .btn-generate {
      background: linear-gradient(90deg, #3f51b5 60%, #4cc9f0 100%);
      color: #fff;
      font-weight: 600;
      border: none;
      border-radius: 50px;
      padding: 0.5rem 1.5rem;
      font-size: 1rem;
      box-shadow: 0 2px 8px rgba(67, 97, 238, 0.10);
      transition: background 0.2s;
    }
    .btn-generate:hover {
      background: linear-gradient(90deg, #4cc9f0 0%, #3f51b5 100%);
    }
    .btn-download {
      position: absolute;
      top: 2.2rem;
      right: 2.5rem;
      background: #4cc9f0;
      color: #fff;
      border: none;
      border-radius: 50px;
      padding: 0.5rem 1.3rem;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(67, 97, 238, 0.10);
      transition: background 0.2s;
    }
    .btn-download:hover {
      background: #3f51b5;
      color: #fff;
    }
    .section-title {
      color: #4cc9f0;
      font-weight: 700;
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      font-size: 1.15rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .section-title svg {
      width: 1.3em;
      height: 1.3em;
      vertical-align: middle;
    }
    .summary-text {
      color: #333;
      font-size: 1.13rem;
      margin-bottom: 1.2rem;
    }
    .insights-list {
      margin-bottom: 1.5rem;
      padding-left: 1.2em;
    }
    .insights-list li {
      margin-bottom: 0.5rem;
      color: #3a0ca3;
      font-weight: 500;
      font-size: 1.05rem;
    }
    .report-charts {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      justify-content: center;
      margin-top: 2.5rem;
      margin-bottom: 1.5rem;
    }
    .chart-container {
      background: #f4f8fb;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(67, 97, 238, 0.06);
      padding: 1.2rem 1.2rem 0.5rem 1.2rem;
      width: 340px;
      height: 340px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .data-table-section {
      margin-top: 2.5rem;
    }
    .data-table-section table {
      width: 100%;
      border-collapse: collapse;
      background: #f8fafc;
      border-radius: 0.5rem;
      overflow: hidden;
    }
    .data-table-section th, .data-table-section td {
      padding: 0.6rem 0.8rem;
      border-bottom: 1px solid #e0e7ef;
      text-align: left;
    }
    .data-table-section th {
      background: #e3f2fd;
      color: #3f51b5;
      font-weight: 700;
    }
    .loader {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      font-size: 1.2rem;
      color: #3f51b5;
    }
    @media (max-width: 1100px) {
      .report-charts { flex-direction: column; align-items: center; }
      .chart-container { width: 100%; max-width: 100%; }
    }
    @media print {
      .btn-download, .btn-dashboard, .report-form, .btn-generate { display: none !important; }
      body { background: #fff !important; }
      @page { size: A4 portrait; margin: 1.2cm; }
      .main-content { padding: 0 !important; min-height: unset !important; }
      .report-card { box-shadow: none !important; border-radius: 0 !important; padding: 0.5cm 0 0.5cm 0 !important; max-width: 100% !important; width: 100% !important; }
      .report-charts { gap: 0.5cm !important; margin-top: 1.2rem !important; margin-bottom: 1.2rem !important; }
      .chart-container { width: 100% !important; max-width: 100% !important; height: auto !important; padding: 0.2cm 0.2cm 0.1cm 0.2cm !important; }
      .chart-container canvas { width: 100% !important; height: 220px !important; max-width: 100% !important; }
      .navbar, .navbar * { display: none !important; }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm mb-0">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="dashboard.html">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="13" width="4" height="8" rx="2" fill="#fff" fill-opacity="0.9"/>
          <rect x="9" y="9" width="4" height="12" rx="2" fill="#fff" fill-opacity="0.7"/>
          <rect x="15" y="3" width="4" height="18" rx="2" fill="#fff" fill-opacity="0.5"/>
        </svg>
        <span class="ms-2 fw-bold">Youth Survey Dashboard</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="report.html">Report</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="about.html">About</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="main-content">
    <div class="report-card">
      <div class="report-header">
        <div class="report-logo">
          <svg width="54" height="54" viewBox="0 0 54 54" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="27" cy="27" r="27" fill="#4cc9f0" fill-opacity="0.15"/>
            <circle cx="27" cy="20" r="7" fill="#3f51b5"/>
            <rect x="16" y="32" width="22" height="8" rx="4" fill="#3f51b5" fill-opacity="0.8"/>
            <rect x="22" y="28" width="10" height="10" rx="5" fill="#4cc9f0"/>
          </svg>
        </div>
        <div>
          <div class="report-title">Youth Survey Report</div>
          <div class="text-muted" style="font-size:1.1rem;">Local Youth Development Office</div>
        </div>
      </div>
      <form class="report-form" id="reportForm" onsubmit="event.preventDefault(); generateReport();">
        <div>
          <label for="startDate">Start Date</label><br>
          <input type="date" id="startDate" name="startDate">
        </div>
        <div>
          <label for="endDate">End Date</label><br>
          <input type="date" id="endDate" name="endDate">
        </div>
        <div>
          <label for="categoryFilter">Categories</label><br>
          <select id="categoryFilter" name="categoryFilter" multiple>
            <!-- Options will be filled dynamically -->
          </select>
        </div>
        <div>
          <button type="submit" class="btn-generate">Generate Report</button>
        </div>
      </form>
      <button class="btn-download" onclick="window.print()" title="Download/Print Report" aria-label="Download/Print Report">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="#fff" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v12m0 0l-4-4m4 4l4-4M4 20h16"/>
        </svg>
      </button>
      <div class="section-title">
        <svg fill="#4cc9f0" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm1 15h-2v-2h2v2zm1.07-7.75-.9.92C11.45 11.9 11 12.5 11 14h2v-.5c0-.55.45-1 1-1s1 .45 1 1c0 1.1-.9 2-2 2s-2-.9-2-2c0-.55.45-1 1-1s1 .45 1 1v.5h2c0-1.1-.45-2.1-1.07-2.75z"/></svg>
        Summary & Insights
      </div>
      <div class="summary-text" id="summaryText">
        <div class="loader">Loading report data...</div>
      </div>
      <div class="section-title">
        <svg fill="#4cc9f0" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm1 15h-2v-2h2v2zm1.07-7.75-.9.92C11.45 11.9 11 12.5 11 14h2v-.5c0-.55.45-1 1-1s1 .45 1 1c0 1.1-.9 2-2 2s-2-.9-2-2c0-.55.45-1 1-1s1 .45 1 1v.5h2c0-1.1-.45-2.1-1.07-2.75z"/></svg>
        Key Insights
      </div>
      <ul class="insights-list" id="insightsList">
        <li class="loader">Loading insights...</li>
      </ul>
      <div class="section-title">
        <svg fill="#4cc9f0" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><rect x="11" y="6" width="2" height="6"/><rect x="11" y="14" width="2" height="2"/></svg>
        Visuals
      </div>
      <div class="report-charts">
        <div class="chart-container">
          <canvas id="barChart" width="260" height="220" aria-label="Attendance by Category" role="img"></canvas>
          <div class="text-center mt-2" style="font-size:0.98rem;color:#3f51b5;font-weight:600;">Attendance by Category</div>
        </div>
        <div class="chart-container">
          <canvas id="pieChart" width="260" height="220" aria-label="Category Distribution" role="img"></canvas>
          <div class="text-center mt-2" style="font-size:0.98rem;color:#3f51b5;font-weight:600;">Category Distribution</div>
        </div>
      </div>
      <div class="section-title">
        <svg fill="#4cc9f0" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><rect x="7" y="7" width="10" height="10" rx="2"/></svg>
        Data Table
      </div>
      <div class="data-table-section" id="dataTableSection">
        <div class="loader">Loading data table...</div>
      </div>
    </div>
  </div>
  <script>
    // Chart.js color palette
    const chartColors = [
      '#4361ee', '#3a0ca3', '#4cc9f0', '#f72585', '#7209b7', '#b5179e', '#4895ef', '#560bad', '#bdb2ff', '#fee440', '#ff6f61', '#43aa8b', '#f9c74f', '#f9844a', '#90be6d'
    ];
    let barChartInstance = null;
    let pieChartInstance = null;
    let reportDataCache = [];
    let allCategories = [];

    async function fetchReportData() {
      try {
        const response = await fetch('/api/survey-attendance');
        const data = await response.json();
        return data;
      } catch (error) {
        return [];
      }
    }

    function getSelectedCategories() {
      const select = document.getElementById('categoryFilter');
      return Array.from(select.selectedOptions).map(opt => opt.value);
    }

    function fillCategoryOptions(data) {
      const select = document.getElementById('categoryFilter');
      select.innerHTML = '';
      const uniqueCategories = [...new Set(data.map(item => item.youth_category))];
      allCategories = uniqueCategories;
      uniqueCategories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        select.appendChild(opt);
      });
      // Select all by default
      Array.from(select.options).forEach(opt => opt.selected = true);
    }

    function generateSummary(filtered, startDate, endDate, selectedCats) {
      if (!filtered.length) return 'No data available for the selected filters.';
      const total = filtered.reduce((sum, item) => sum + item.attendance_count, 0);
      const top = filtered.slice().sort((a, b) => b.attendance_count - a.attendance_count)[0];
      let datePhrase = '';
      if (startDate && endDate) datePhrase = `from <strong>${startDate}</strong> to <strong>${endDate}</strong> `;
      let catPhrase = '';
      if (selectedCats.length && selectedCats.length !== allCategories.length) {
        catPhrase = `for <strong>${selectedCats.join(', ')}</strong> `;
      }
      return `Between ${datePhrase}${catPhrase}there were <strong>${total}</strong> total participants. The highest attendance was in <strong>${top.youth_category}</strong> (<strong>${top.attendance_count}</strong> participants).`;
    }

    function generateInsights(filtered) {
      if (!filtered.length) return '<li>No data available.</li>';
      const sorted = filtered.slice().sort((a, b) => b.attendance_count - a.attendance_count);
      const top3 = sorted.slice(0, 3);
      const bottom3 = sorted.slice(-3).reverse();
      const total = filtered.reduce((sum, item) => sum + item.attendance_count, 0);
      const avg = (total / filtered.length).toFixed(2);
      const engagement = ((total / 300) * 100).toFixed(1); // 300 is example max
      let trend = 'Stable attendance across most categories.';
      if (top3[0].attendance_count > avg * 1.5) trend = `Significant engagement in <strong>${top3[0].youth_category}</strong>.`;
      if (bottom3[0].attendance_count < avg * 0.5) trend += ` Low engagement in <strong>${bottom3[0].youth_category}</strong>.`;
      return `
        <li><strong>Top 3 Categories:</strong> ${top3.map(c => `${c.youth_category} (${c.attendance_count})`).join(', ')}</li>
        <li><strong>Bottom 3 Categories:</strong> ${bottom3.map(c => `${c.youth_category} (${c.attendance_count})`).join(', ')}</li>
        <li><strong>Average Attendance per Category:</strong> ${avg}</li>
        <li><strong>Engagement Rate:</strong> ${engagement}% (estimated)</li>
        <li><strong>Major Trend:</strong> ${trend}</li>
      `;
    }

    function fillDataTable(filtered) {
      if (!filtered.length) {
        document.getElementById('dataTableSection').innerHTML = '<div>No data available.</div>';
        return;
      }
      let html = '<table><thead><tr><th>Category</th><th>Attendance</th></tr></thead><tbody>';
      filtered.forEach(row => {
        html += `<tr><td>${row.youth_category}</td><td>${row.attendance_count}</td></tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('dataTableSection').innerHTML = html;
    }

    function fillCharts(filtered) {
      const labels = filtered.map(item => item.youth_category);
      const attendance = filtered.map(item => item.attendance_count);
      if (barChartInstance) barChartInstance.destroy();
      if (pieChartInstance) pieChartInstance.destroy();
      barChartInstance = new Chart(document.getElementById('barChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Attendance',
            data: attendance,
            backgroundColor: labels.map((_, i) => chartColors[i % chartColors.length]),
            borderColor: labels.map((_, i) => chartColors[i % chartColors.length]),
            borderWidth: 2
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
      pieChartInstance = new Chart(document.getElementById('pieChart').getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: attendance,
            backgroundColor: labels.map((_, i) => chartColors[i % chartColors.length]),
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    function filterData(data, startDate, endDate, selectedCats) {
      let filtered = [...data];
      // (If you add date fields, filter here)
      if (selectedCats.length && selectedCats.length !== allCategories.length) {
        filtered = filtered.filter(item => selectedCats.includes(item.youth_category));
      }
      return filtered;
    }

    async function initializeReport() {
      document.getElementById('summaryText').innerHTML = '<div class="loader">Loading report data...</div>';
      document.getElementById('insightsList').innerHTML = '<li class="loader">Loading insights...</li>';
      document.getElementById('dataTableSection').innerHTML = '<div class="loader">Loading data table...</div>';
      reportDataCache = await fetchReportData();
      fillCategoryOptions(reportDataCache);
      generateReport();
    }

    function generateReport() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const selectedCats = getSelectedCategories();
      const filtered = filterData(reportDataCache, startDate, endDate, selectedCats);
      document.getElementById('summaryText').innerHTML = generateSummary(filtered, startDate, endDate, selectedCats);
      document.getElementById('insightsList').innerHTML = generateInsights(filtered);
      fillCharts(filtered);
      fillDataTable(filtered);
    }

    window.onload = initializeReport;
  </script>
</body>
</html> 